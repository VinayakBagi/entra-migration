<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Franchise Portal</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: linear-gradient(135deg, #0095ff 0%, #0078d4 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 500px;
      }

      .logo-text {
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        color: #0078d4;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 28px;
        color: #333;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
      }

      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1dfdd;
        border-radius: 6px;
        font-size: 16px;
      }

      input:focus {
        outline: none;
        border-color: #0078d4;
      }

      .otp-input {
        font-size: 24px;
        letter-spacing: 8px;
        text-align: center;
        font-weight: bold;
      }

      .btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background-color: #0078d4;
        color: white;
      }

      .btn-primary:hover {
        background-color: #005a9e;
      }

      .btn-primary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #f3f2f1;
        color: #333;
        margin-top: 10px;
      }

      .message-box {
        display: none;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .message-box.show {
        display: block;
      }

      .message-box.warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        color: #856404;
      }

      .message-box.success {
        background: #d4edda;
        border: 2px solid #28a745;
        color: #155724;
      }

      .message-box.error {
        background: #f8d7da;
        border: 2px solid #dc3545;
        color: #721c24;
      }

      .step {
        display: none;
      }

      .step.active {
        display: block;
      }

      .back-link {
        display: block;
        text-align: center;
        margin-top: 20px;
        color: #0078d4;
        text-decoration: none;
      }

      .timer {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo-text">FRANCHISE PORTAL</div>

      <!-- Step 1: Enter Email -->
      <div id="step1" class="step active">
        <h1>Reset Your Password</h1>
        <p class="subtitle">Enter your email to receive a verification code</p>

        <form id="emailForm">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" required />
          </div>
          <button type="submit" class="btn btn-primary" id="sendBtn">
            Send Code
          </button>
        </form>

        <div class="message-box warning" id="dummyWarning">
          <strong>⚠️ This is a test account</strong>
          <p>Please contact: admin@yourcompany.com</p>
        </div>

        <a href="/" class="back-link">← Back to Sign In</a>
      </div>

      <!-- Step 2: Enter OTP -->
      <div id="step2" class="step">
        <h1>Enter Code</h1>
        <p class="subtitle">
          We sent a code to <strong id="emailDisplay"></strong>
        </p>

        <form id="otpForm">
          <div class="form-group">
            <label for="otp">Verification Code</label>
            <input
              type="text"
              id="otp"
              class="otp-input"
              maxlength="8"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Verify Code</button>
          <button type="button" class="btn btn-secondary" id="resendBtn">
            Resend Code
          </button>
        </form>

        <div class="message-box error" id="otpError"></div>
        <div class="timer">
          Code expires in <span id="countdown">10:00</span>
        </div>
      </div>

      <!-- Step 3: Set New Password -->
      <div id="step3" class="step">
        <h1>Set New Password</h1>
        <p class="subtitle">Choose a strong password</p>

        <form id="passwordForm">
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" required />
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input type="password" id="confirmPassword" required />
          </div>
          <button type="submit" class="btn btn-primary">Reset Password</button>
        </form>

        <div class="message-box error" id="passwordError"></div>
      </div>

      <!-- Step 4: Success -->
      <div id="step4" class="step">
        <div class="message-box success show">
          <strong>✓ Password Reset Successfully</strong>
          <p>You can now sign in with your new password</p>
          <p style="margin-top: 10px; font-size: 14px">
            Redirecting in <span id="redirectCountdown">3</span> seconds...
          </p>
        </div>
        <button
          class="btn btn-primary"
          onclick="window.location.href='https://mtysnjyacmskahaladev.cfapps.us10-001.hana.ondemand.com/index.html'"
        >
          Go to Sign In Now
        </button>
      </div>
    </div>

    <script>
      const API_URL = "https://entra-migration.onrender.com";

      let continuationToken = null;
      let userEmail = null;

      // Step 1: Send Code
      document
        .getElementById("emailForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const sendBtn = document.getElementById("sendBtn");

          sendBtn.disabled = true;
          sendBtn.textContent = "Sending...";

          try {
            // Step 1: Call /start to initialize the session
            const response = await fetch(`${API_URL}/api/sspr/start`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });

            const data = await response.json();

            if (data.isDummyUser) {
              document.getElementById("dummyWarning").classList.add("show");
              return;
            }

            if (!data.success) {
              alert(data.message || "Error sending code");
              return;
            }

            // Step 2: Call /challenge to trigger OTP email send
            continuationToken = data.continuationToken;
            sendBtn.textContent = "Sending OTP...";

            const challengeResponse = await fetch(
              `${API_URL}/api/sspr/challenge`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ continuationToken }),
              }
            );

            const challengeData = await challengeResponse.json();

            if (challengeData.success) {
              continuationToken = challengeData.continuationToken;
              userEmail = email;
              document.getElementById("emailDisplay").textContent = email;
              goToStep(2);
              startCountdown(600);
            } else {
              alert(challengeData.error || "Error sending OTP");
            }
          } catch (error) {
            alert("Error: " + error.message);
          } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = "Send Code";
          }
        });

      // Step 2: Verify OTP
      document
        .getElementById("otpForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const otp = document.getElementById("otp").value.trim();
          const otpError = document.getElementById("otpError");

          otpError.classList.remove("show");

          try {
            const response = await fetch(`${API_URL}/api/sspr/verify-otp`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ continuationToken, otp }),
            });

            const data = await response.json();

            if (data.success) {
              continuationToken = data.continuationToken;
              goToStep(3);
            } else {
              otpError.textContent = data.error || "Invalid code";
              otpError.classList.add("show");
            }
          } catch (error) {
            otpError.textContent = "Error: " + error.message;
            otpError.classList.add("show");
          }
        });

      // Step 3: Submit Password
      document
        .getElementById("passwordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;
          const passwordError = document.getElementById("passwordError");

          passwordError.classList.remove("show");

          if (newPassword !== confirmPassword) {
            passwordError.textContent = "Passwords do not match";
            passwordError.classList.add("show");
            return;
          }

          if (newPassword.length < 8) {
            passwordError.textContent =
              "Password must be at least 8 characters";
            passwordError.classList.add("show");
            return;
          }

          try {
            const response = await fetch(
              `${API_URL}/api/sspr/submit-password`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ continuationToken, newPassword }),
              }
            );

            const data = await response.json();

            if (data.success) {
              goToStep(4);
            } else {
              passwordError.textContent =
                data.error || "Failed to reset password";
              passwordError.classList.add("show");
            }
          } catch (error) {
            passwordError.textContent = "Error: " + error.message;
            passwordError.classList.add("show");
          }
        });

      // Resend Code
      document
        .getElementById("resendBtn")
        .addEventListener("click", async () => {
          const resendBtn = document.getElementById("resendBtn");
          resendBtn.disabled = true;
          resendBtn.textContent = "Resending...";

          try {
            // Call /start to reinitialize
            const response = await fetch(`${API_URL}/api/sspr/start`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email: userEmail }),
            });

            const data = await response.json();

            if (data.success) {
              // Call /challenge to trigger OTP send
              const challengeResponse = await fetch(
                `${API_URL}/api/sspr/challenge`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    continuationToken: data.continuationToken,
                  }),
                }
              );

              const challengeData = await challengeResponse.json();

              if (challengeData.success) {
                continuationToken = challengeData.continuationToken;
                alert("New code sent!");
                startCountdown(600);
              } else {
                alert("Error sending new code");
              }
            }
          } catch (error) {
            alert("Error resending code");
          } finally {
            resendBtn.disabled = false;
            resendBtn.textContent = "Resend Code";
          }
        });

      function goToStep(step) {
        document
          .querySelectorAll(".step")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(`step${step}`).classList.add("active");

        // Auto-redirect after successful password reset
        if (step === 4) {
          startRedirectCountdown(3);
        }
      }

      function startRedirectCountdown(seconds) {
        const REDIRECT_URL =
          "https://mtysnjyacmskahaladev.cfapps.us10-001.hana.ondemand.com/index.html";
        const countdownEl = document.getElementById("redirectCountdown");
        let remaining = seconds;

        const interval = setInterval(() => {
          countdownEl.textContent = remaining;
          remaining--;

          if (remaining < 0) {
            clearInterval(interval);
            window.location.href = REDIRECT_URL;
          }
        }, 1000);
      }

      function startCountdown(seconds) {
        const countdownEl = document.getElementById("countdown");
        let remaining = seconds;

        const interval = setInterval(() => {
          const mins = Math.floor(remaining / 60);
          const secs = remaining % 60;
          countdownEl.textContent = `${mins}:${secs
            .toString()
            .padStart(2, "0")}`;
          remaining--;

          if (remaining < 0) {
            clearInterval(interval);
            countdownEl.textContent = "Expired";
          }
        }, 1000);
      }
    </script>
  </body>
</html>
